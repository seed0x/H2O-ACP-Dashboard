name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  # Quick validation for PRs
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Check for migration conflicts
        working-directory: apps/api
        run: |
          echo "Checking for migration conflicts..."
          # Ensure migrations are in order
          python -c "
          import os
          import re
          from pathlib import Path
          
          migrations = sorted(Path('alembic/versions').glob('*.py'))
          revisions = []
          for m in migrations:
              with open(m) as f:
                  content = f.read()
                  rev_match = re.search(r\"revision = ['\\\"]([^'\\\"]+)['\\\"]\", content)
                  down_match = re.search(r\"down_revision = ['\\\"]?([^'\\\"]*)['\\\"]?\", content)
                  if rev_match:
                      revisions.append({
                          'file': m.name,
                          'revision': rev_match.group(1),
                          'down_revision': down_match.group(1) if down_match else None
                      })
          
          # Check for duplicate revisions
          rev_ids = [r['revision'] for r in revisions]
          if len(rev_ids) != len(set(rev_ids)):
              print('❌ Duplicate revision IDs found!')
              exit(1)
          
          print('✅ Migration structure looks good')
          "
        continue-on-error: true
      
      - name: Check for large files
        run: |
          echo "Checking for unexpectedly large files..."
          find . -type f -size +5M ! -path './.git/*' ! -path './node_modules/*' ! -path './__pycache__/*' | head -10
        continue-on-error: true
      
      - name: Validate file structure
        run: |
          echo "Validating project structure..."
          [ -f "apps/api/Dockerfile" ] || (echo "❌ Missing apps/api/Dockerfile" && exit 1)
          [ -f "apps/web/Dockerfile" ] || (echo "❌ Missing apps/web/Dockerfile" && exit 1)
          [ -f "apps/api/requirements.txt" ] || (echo "❌ Missing apps/api/requirements.txt" && exit 1)
          [ -f "apps/web/package.json" ] || (echo "❌ Missing apps/web/package.json" && exit 1)
          echo "✅ Project structure valid"

