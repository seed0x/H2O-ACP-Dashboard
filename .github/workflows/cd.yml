name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Deploy to Render (optional - requires Render API key)
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          # Only deploy if Render API key is configured
          if [ -z "$RENDER_API_KEY" ]; then
            echo "Render API key not configured, skipping deployment"
            exit 0
          fi
          
          # Trigger Render deployment via API
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "do_not_clear"}'
      
      - name: Wait for deployment
        if: env.RENDER_API_KEY != ''
        run: |
          echo "Deployment triggered. Monitor at: https://dashboard.render.com"
          echo "Note: Render auto-deploys on git push, so this may be redundant"

  # Notify on deployment
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-render]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-render.result }}" == "success" ]; then
            echo "✅ Deployment pipeline completed successfully"
          else
            echo "⚠️ Deployment pipeline completed with warnings"
          fi

